{{$prefix := or (env "DEPLOYMENT_PREFIX") ""}}
{{if or (eq .env "local") (eq .env "review")}}
{{/* We only use buildconfigs if the environment is local, or review. */}}
---
kind: BuildConfig
apiVersion: v1
metadata:
  name: {{$prefix}}{{.name}}-nginx
  labels:
{{if (env "CI_COMMIT_REF_SLUG")}}
    app: {{env "CI_COMMIT_REF_SLUG"}}
{{end}}
    deployment: {{$prefix}}{{.name}}-deployment
{{if (env "GITLAB_DEPLOYMENT")}}
    gitlab-deployment: {{env "GITLAB_DEPLOYMENT"}}
{{end}}
spec:
  failedBuildsHistoryLimit: 5
  output:
    to:
      kind: ImageStreamTag
      name: {{$prefix}}{{.nginx.imageStreamName}}:{{.nginx.imageStreamTag}}
  runPolicy: Serial
  source:
    contextDir: {{.nginx.repoContextDir}}
    git:
      uri: {{env "NGINX_REPO_URI" | default .nginx.repoUri}}
      ref: {{env "NGINX_REPO_REF" | default .nginx.repoUriBranch}}
    type: Git
  strategy:
    type: Source
    sourceStrategy:
      from:
        kind: DockerImage
        name: {{.nginx.baseImage}}
  triggers:
  - type: ConfigChange
  - imageChange: {}
    type: ImageChange
{{if ne .env "local"}}
{{/* Resource limits are only relevant when we're running in OSD */}}
  resources:
    requests:
      cpu: {{.nginx.limits.build.cpuRequest}}
      memory: {{.nginx.limits.build.memRequest}}
    limits:
      cpu: {{.nginx.limits.build.cpuLimit}}
      memory: {{.nginx.limits.build.memLimit}}
{{end}}
---
kind: BuildConfig
apiVersion: v1
metadata:
  name: {{$prefix}}{{.name}}-api
  labels:
{{if (env "CI_COMMIT_REF_SLUG")}}
    app: {{env "CI_COMMIT_REF_SLUG"}}
{{end}}
    deployment: {{$prefix}}{{.name}}-deployment
{{if (env "GITLAB_DEPLOYMENT")}}
    gitlab-deployment: {{env "GITLAB_DEPLOYMENT"}}
{{end}}
spec:
  failedBuildsHistoryLimit: 5
  runPolicy: Serial
  strategy:
    type: Docker
  source:
    type: Git
    git:
      uri: {{env "API_REPO_URI" | default .api.repoUri}}
      ref: {{env "API_REPO_REF" | default .api.repoUriBranch}}
  output:
    to:
      kind: ImageStreamTag
      name: {{$prefix}}{{.api.imageStreamName}}:{{.api.imageStreamTag}}
  triggers:
  - type: ConfigChange
  - imageChange: {}
    type: ImageChange
{{if ne .env "local"}}
  resources:
    requests:
      cpu: {{.api.limits.build.cpuRequest}}
      memory: {{.api.limits.build.memRequest}}
    limits:
      cpu: {{.api.limits.build.cpuLimit}}
      memory: {{.api.limits.build.memLimit}}
{{end}}
{{end}}
