{{$prefix := or (env "DEPLOYMENT_PREFIX") ""}}
---
kind: DeploymentConfig
apiVersion: v1
metadata:
  name: {{$prefix}}{{.name}}-api
  labels:
{{if (env "CI_ENVIRONMENT_SLUG")}}
    app: {{env "CI_ENVIRONMENT_SLUG"}}
{{end}}
    deployment: {{$prefix}}{{.name}}-deployment
{{if (env "GITLAB_DEPLOYMENT")}}
    gitlab-deployment: {{env "GITLAB_DEPLOYMENT"}}
{{end}}
spec:
  selector:
    name: {{$prefix}}{{.name}}-api
  replicas: {{.api.replicaCount}}
  revisionHistoryLimit: 10
  strategy:
    recreateParams:
      mid:
        execNewPod:
          command:
          - scl
          - enable
          - rh-python36
          - ./manage.py migrate
          containerName: {{$prefix}}{{.name}}-api
        failurePolicy: Abort
    type: Recreate
  template:
    metadata:
      labels:
        name: {{$prefix}}{{.name}}-api
    spec:
      containers:
      - name: {{$prefix}}{{.name}}-api
        env:
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              key: aws-access-key-id
              name: {{$prefix}}{{.name}}
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key: aws-secret-access-key
              name: {{$prefix}}{{.name}}
        - name: AWS_DEFAULT_REGION
          valueFrom:
            configMapKeyRef:
              key: aws-default-region
              name: {{$prefix}}{{.name}}
        - name: AWS_SQS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              key: aws-sqs-access-key-id
              name: {{$prefix}}{{.name}}
        - name: AWS_SQS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key: aws-sqs-secret-access-key
              name: {{$prefix}}{{.name}}
        - name: AWS_SQS_REGION
          valueFrom:
            configMapKeyRef:
              key: aws-sqs-region
              name: {{$prefix}}{{.name}}
        - name: AWS_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              key: aws-name-prefix
              name: {{$prefix}}{{.name}}
        - name: DJANGO_SETTINGS_MODULE
          valueFrom:
            configMapKeyRef:
              key: django-settings-module
              name: {{$prefix}}{{.name}}
        - name: DJANGO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: django-secret-key
              name: {{$prefix}}{{.name}}
        - name: DJANGO_ALLOWED_HOSTS
          valueFrom:
            configMapKeyRef:
              key: django-allowed-hosts
              name: {{$prefix}}{{.name}}
{{if or (eq .env "local") (eq .env "review")}}
        - name: DJANGO_DATABASE_NAME
          valueFrom:
            secretKeyRef:
              key: database-name
              name: {{env "DB_SECRETS_FILE_NAME" | default .db.secretsFileName}}
        - name: DJANGO_DATABASE_HOST
          valueFrom:
            configMapKeyRef:
              key: django-database-host
              name: {{$prefix}}{{.name}}
        - name: DJANGO_DATABASE_USER
          valueFrom:
            secretKeyRef:
              key: database-user
              name: {{env "DB_SECRETS_FILE_NAME" | default .db.secretsFileName}}
        - name: DJANGO_DATABASE_PASSWORD
          valueFrom:
            secretKeyRef:
              key: database-password
              name: {{env "DB_SECRETS_FILE_NAME" | default .db.secretsFileName}}
{{else}}
        - name: DJANGO_DATABASE_NAME
          valueFrom:
            configMapKeyRef:
              key: database-name
              name: {{$prefix}}{{.name}}
        - name: DJANGO_DATABASE_PORT
          valueFrom:
            configMapKeyRef:
              key: database-port
              name: {{$prefix}}{{.name}}
        - name: DJANGO_DATABASE_HOST
          valueFrom:
            configMapKeyRef:
              key: django-database-host
              name: {{$prefix}}{{.name}}
        - name: DJANGO_DATABASE_USER
          valueFrom:
            secretKeyRef:
              key: database-user
              name: {{$prefix}}{{.name}}
        - name: DJANGO_DATABASE_PASSWORD
          valueFrom:
            secretKeyRef:
              key: database-password
              name: {{$prefix}}{{.name}}
{{end}}
        - name: DJANGO_DEBUG
          valueFrom:
            configMapKeyRef:
              key: django-debug
              name: {{$prefix}}{{.name}}
        - name: HOUNDIGRADE_ECS_CLUSTER_NAME
          valueFrom:
            configMapKeyRef:
              key: aws-houndigrade-ecs-cluster-name
              name: {{$prefix}}{{.name}}
        - name: HOUNDIGRADE_ECS_IMAGE_NAME
          valueFrom:
            configMapKeyRef:
              key: aws-houndigrade-ecs-image-name
              name: {{$prefix}}{{.name}}
        - name: HOUNDIGRADE_ECS_IMAGE_TAG
          valueFrom:
            configMapKeyRef:
              key: aws-houndigrade-ecs-image-tag
              name: {{$prefix}}{{.name}}
        - name: HOUNDIGRADE_ECS_FAMILY_NAME
          valueFrom:
            configMapKeyRef:
              key: aws-houndigrade-ecs-family-name
              name: {{$prefix}}{{.name}}
        - name: HOUNDIGRADE_AWS_AVAILABILITY_ZONE
          valueFrom:
            configMapKeyRef:
              key: aws-houndigrade-availability-zone
              name: {{$prefix}}{{.name}}
        - name: HOUNDIGRADE_AWS_AUTOSCALING_GROUP_NAME
          valueFrom:
            configMapKeyRef:
              key: aws-houndigrade-autoscaling-group-name
              name: {{$prefix}}{{.name}}
        - name: CLOUDTRAIL_EVENT_URL
          valueFrom:
            configMapKeyRef:
              key: aws-cloudtrail-event-url
              name: {{$prefix}}{{.name}}
        - name: S3_BUCKET_NAME
          valueFrom:
            configMapKeyRef:
              key: aws-s3-bucket-name
              name: {{$prefix}}{{.name}}
{{if or (env "API_SENTRY_ENABLED") (.api.sentry.enabled)}}
        - name: API_ENABLE_SENTRY
          valueFrom:
            configMapKeyRef:
              key: api-sentry-enabled
              name: {{$prefix}}{{.name}}
        - name: DJANGO_SENTRY_DSN
          valueFrom:
            secretKeyRef:
              key: api-sentry-dsn
              name: {{$prefix}}{{.name}}
        - name: DJANGO_SENTRY_RELEASE
          valueFrom:
            configMapKeyRef:
              key: api-sentry-release
              name: {{$prefix}}{{.name}}
        - name: DJANGO_SENTRY_ENVIRONMENT
          valueFrom:
            configMapKeyRef:
              key: api-sentry-environment
              name: {{$prefix}}{{.name}}
{{end}}
{{if or (env "HOUNDIGRADE_SENTRY_ENABLED") (.aws.houndigrade.sentry.enabled)}}
        - name: HOUNDIGRADE_ENABLE_SENTRY
          valueFrom:
            configMapKeyRef:
              key: houndigrade-sentry-enabled
              name: {{$prefix}}{{.name}}
        - name: HOUNDIGRADE_SENTRY_DSN
          valueFrom:
            secretKeyRef:
              key: houndigrade-sentry-dsn
              name: {{$prefix}}{{.name}}
        - name: HOUNDIGRADE_SENTRY_RELEASE
          valueFrom:
            configMapKeyRef:
              key: aws-houndigrade-ecs-image-tag
              name: {{$prefix}}{{.name}}
        - name: HOUNDIGRADE_SENTRY_ENVIRONMENT
          valueFrom:
            configMapKeyRef:
              key: houndigrade-sentry-environment
              name: {{$prefix}}{{.name}}
{{end}}
{{if and (ne .env "local") (ne .env "review")}}
        image: {{env "API_IMAGE"}}
{{else}}
        image: ' '
        imagePullPolicy: Always
{{end}}
{{if ne .env "local"}}
        resources:
          requests:
            cpu: {{.api.limits.container.cpuRequest}}
            memory: {{.api.limits.container.memRequest}}
          limits:
            cpu: {{.api.limits.container.cpuLimit}}
            memory: {{.api.limits.container.memLimit}}
{{end}}
        livenessProbe:
          exec:
            command:
              - /bin/sh
              - -c
              - 'ps axo command | grep -v grep | grep gunicorn'
          failureThreshold: 3
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        readinessProbe:
          exec:
            command:
              - /bin/sh
              - -c
              - 'nc -U /var/run/cloudigrade/gunicorn.sock --send-only </dev/null'
          failureThreshold: 3
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        volumeMounts:
        - mountPath: /var/run/cloudigrade
          name: {{$prefix}}{{.name}}-socket
      - name: {{$prefix}}nginx
{{if and (ne .env "local") (ne .env "review")}}
        image: {{env "NGINX_IMAGE"}}
{{else}}
        image: ' '
        imagePullPolicy: Always
{{end}}
        ports:
        - containerPort: {{.nginx.port}}
          protocol: TCP
{{if ne .env "local"}}
        resources:
          requests:
            cpu: {{.nginx.limits.container.cpuRequest}}
            memory: {{.nginx.limits.container.memRequest}}
          limits:
            cpu: {{.nginx.limits.container.cpuLimit}}
            memory: {{.nginx.limits.container.memLimit}}
{{end}}
        livenessProbe:
          tcpSocket:
            port: {{.nginx.port}}
          failureThreshold: 3
          initialDelaySeconds: 3
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        readinessProbe:
          failureThreshold: 3
          httpGet:
            path: /healthz/
            port: {{.nginx.port}}
            scheme: HTTP
            httpHeaders:
              - name: Host
                value: {{.healthCheckHostHeader}}
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        volumeMounts:
        - mountPath: /var/run/cloudigrade
          name: {{$prefix}}{{.name}}-socket
      volumes:
      - name: {{$prefix}}{{.name}}-socket
        emptyDir: {}
{{if or (eq .env "local") (eq .env "review")}}
  triggers:
    - type: "ImageChange"
      imageChangeParams:
        automatic: {{.api.enableImageChangeTrigger}}
        containerNames:
          - {{$prefix}}{{.name}}-api
        from:
          kind: ImageStreamTag
          name: {{$prefix}}{{.api.imageStreamName}}:{{.api.imageStreamTag}}
    - type: ImageChange
      imageChangeParams:
        automatic: {{.nginx.enableImageChangeTrigger}}
        containerNames:
          - {{$prefix}}nginx
        from:
          kind: ImageStreamTag
          name: {{$prefix}}{{.nginx.imageStreamName}}:{{.nginx.imageStreamTag}}
    - type: ConfigChange
{{end}}
---
kind: DeploymentConfig
apiVersion: v1
metadata:
  name: {{$prefix}}{{.name}}-celery-beat
  labels:
{{if (env "CI_ENVIRONMENT_SLUG")}}
    app: {{env "CI_ENVIRONMENT_SLUG"}}
{{end}}
    deployment: {{$prefix}}{{.name}}-deployment
{{if (env "GITLAB_DEPLOYMENT")}}
    gitlab-deployment: {{env "GITLAB_DEPLOYMENT"}}
{{end}}
spec:
  selector:
    name: {{$prefix}}{{.name}}-celery-beat
  replicas: {{.celery.beat.replicaCount}}
  revisionHistoryLimit: 10
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        name: {{$prefix}}{{.name}}-celery-beat
    spec:
      containers:
      - name: {{$prefix}}{{.name}}-celery-beat
        env:
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              key: aws-access-key-id
              name: {{$prefix}}{{.name}}
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key: aws-secret-access-key
              name: {{$prefix}}{{.name}}
        - name: AWS_DEFAULT_REGION
          valueFrom:
            configMapKeyRef:
              key: aws-default-region
              name: {{$prefix}}{{.name}}
        - name: AWS_SQS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              key: aws-sqs-access-key-id
              name: {{$prefix}}{{.name}}
        - name: AWS_SQS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key: aws-sqs-secret-access-key
              name: {{$prefix}}{{.name}}
        - name: AWS_SQS_REGION
          valueFrom:
            configMapKeyRef:
              key: aws-sqs-region
              name: {{$prefix}}{{.name}}
        - name: AWS_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              key: aws-name-prefix
              name: {{$prefix}}{{.name}}
        - name: DJANGO_SETTINGS_MODULE
          valueFrom:
            configMapKeyRef:
              key: django-settings-module
              name: {{$prefix}}{{.name}}
        - name: DJANGO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: django-secret-key
              name: {{$prefix}}{{.name}}
        - name: DJANGO_ALLOWED_HOSTS
          valueFrom:
            configMapKeyRef:
              key: django-allowed-hosts
              name: {{$prefix}}{{.name}}
{{if or (eq .env "local") (eq .env "review")}}
        - name: DJANGO_DATABASE_NAME
          valueFrom:
            secretKeyRef:
              key: database-name
              name: {{env "DB_SECRETS_FILE_NAME" | default .db.secretsFileName}}
        - name: DJANGO_DATABASE_HOST
          valueFrom:
            configMapKeyRef:
              key: django-database-host
              name: {{$prefix}}{{.name}}
        - name: DJANGO_DATABASE_USER
          valueFrom:
            secretKeyRef:
              key: database-user
              name: {{env "DB_SECRETS_FILE_NAME" | default .db.secretsFileName}}
        - name: DJANGO_DATABASE_PASSWORD
          valueFrom:
            secretKeyRef:
              key: database-password
              name: {{env "DB_SECRETS_FILE_NAME" | default .db.secretsFileName}}
{{else}}
        - name: DJANGO_DATABASE_NAME
          valueFrom:
            configMapKeyRef:
              key: database-name
              name: {{$prefix}}{{.name}}
        - name: DJANGO_DATABASE_PORT
          valueFrom:
            configMapKeyRef:
              key: database-port
              name: {{$prefix}}{{.name}}
        - name: DJANGO_DATABASE_HOST
          valueFrom:
            configMapKeyRef:
              key: django-database-host
              name: {{$prefix}}{{.name}}
        - name: DJANGO_DATABASE_USER
          valueFrom:
            secretKeyRef:
              key: database-user
              name: {{$prefix}}{{.name}}
        - name: DJANGO_DATABASE_PASSWORD
          valueFrom:
            secretKeyRef:
              key: database-password
              name: {{$prefix}}{{.name}}
{{end}}
        - name: DJANGO_DEBUG
          valueFrom:
            configMapKeyRef:
              key: django-debug
              name: {{$prefix}}{{.name}}
        - name: HOUNDIGRADE_ECS_CLUSTER_NAME
          valueFrom:
            configMapKeyRef:
              key: aws-houndigrade-ecs-cluster-name
              name: {{$prefix}}{{.name}}
        - name: HOUNDIGRADE_ECS_IMAGE_NAME
          valueFrom:
            configMapKeyRef:
              key: aws-houndigrade-ecs-image-name
              name: {{$prefix}}{{.name}}
        - name: HOUNDIGRADE_ECS_IMAGE_TAG
          valueFrom:
            configMapKeyRef:
              key: aws-houndigrade-ecs-image-tag
              name: {{$prefix}}{{.name}}
        - name: HOUNDIGRADE_ECS_FAMILY_NAME
          valueFrom:
            configMapKeyRef:
              key: aws-houndigrade-ecs-family-name
              name: {{$prefix}}{{.name}}
        - name: HOUNDIGRADE_AWS_AVAILABILITY_ZONE
          valueFrom:
            configMapKeyRef:
              key: aws-houndigrade-availability-zone
              name: {{$prefix}}{{.name}}
        - name: HOUNDIGRADE_AWS_AUTOSCALING_GROUP_NAME
          valueFrom:
            configMapKeyRef:
              key: aws-houndigrade-autoscaling-group-name
              name: {{$prefix}}{{.name}}
        - name: SCALE_UP_INSPECTION_CLUSTER_SCHEDULE
          valueFrom:
            configMapKeyRef:
              key: aws-houndigrade-scale-up-cluster-schedule
              name: {{$prefix}}{{.name}}
        - name: PERSIST_INSPECTION_CLUSTER_RESULTS_SCHEDULE
          valueFrom:
            configMapKeyRef:
              key: aws-houndigrade-persist-inspection-results-schedule
              name: {{$prefix}}{{.name}}
        - name: CLOUDTRAIL_EVENT_URL
          valueFrom:
            configMapKeyRef:
              key: aws-cloudtrail-event-url
              name: {{$prefix}}{{.name}}
        - name: S3_BUCKET_NAME
          valueFrom:
            configMapKeyRef:
              key: aws-s3-bucket-name
              name: {{$prefix}}{{.name}}
{{if or (env "CELERY_SENTRY_ENABLED") (.celery.sentry.enabled)}}
        - name: CELERY_ENABLE_SENTRY
          valueFrom:
            configMapKeyRef:
              key: celery-sentry-enabled
              name: {{$prefix}}{{.name}}
        - name: CELERY_SENTRY_DSN
          valueFrom:
            secretKeyRef:
              key: celery-sentry-dsn
              name: {{$prefix}}{{.name}}
        - name: CELERY_SENTRY_RELEASE
          valueFrom:
            configMapKeyRef:
              key: celery-sentry-release
              name: {{$prefix}}{{.name}}
        - name: CELERY_SENTRY_ENVIRONMENT
          valueFrom:
            configMapKeyRef:
              key: celery-sentry-environment
              name: {{$prefix}}{{.name}}
{{end}}
{{if and (ne .env "local") (ne .env "review")}}
        image: {{env "CELERY_IMAGE"}}
{{else}}
        image: ' '
        imagePullPolicy: Always
{{end}}
        command:
          - /bin/sh
          - -c
          - >
            PYTHONPATH=. scl enable rh-python36 --
            celery beat
            --app config
            --loglevel info
            --pidfile=
            --scheduler django_celery_beat.schedulers:DatabaseScheduler
{{if ne .env "local"}}
        resources:
          requests:
            cpu: {{.celery.beat.limits.container.cpuRequest}}
            memory: {{.celery.beat.limits.container.memRequest}}
          limits:
            cpu: {{.celery.beat.limits.container.cpuLimit}}
            memory: {{.celery.beat.limits.container.memLimit}}
{{end}}
        livenessProbe:
          exec:
            command:
              - /bin/sh
              - -c
              - 'ps axo command | grep -v grep | grep python'
          failureThreshold: 3
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        readinessProbe:
          exec:
            command:
              - /bin/sh
              - -c
              - '[[ $(ps axo command | grep "[p]ython" | grep celery | grep -c beat) -gt 1 ]]'
          failureThreshold: 3
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
{{if or (eq .env "local") (eq .env "review")}}
  triggers:
    - type: "ImageChange"
      imageChangeParams:
        automatic: {{.celery.enableImageChangeTrigger}}
        containerNames:
          - {{$prefix}}{{.name}}-celery-beat
        from:
          kind: ImageStreamTag
          name: {{$prefix}}{{.celery.imageStreamName}}:{{.celery.imageStreamTag}}
    - type: ConfigChange
{{end}}
---
kind: DeploymentConfig
apiVersion: v1
metadata:
  name: {{$prefix}}{{.name}}-celery-worker
  labels:
{{if (env "CI_ENVIRONMENT_SLUG")}}
    app: {{env "CI_ENVIRONMENT_SLUG"}}
{{end}}
    deployment: {{$prefix}}{{.name}}-deployment
{{if (env "GITLAB_DEPLOYMENT")}}
    gitlab-deployment: {{env "GITLAB_DEPLOYMENT"}}
{{end}}
spec:
  selector:
    name: {{$prefix}}{{.name}}-celery-worker
  replicas: {{.celery.worker.replicaCount}}
  revisionHistoryLimit: 10
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        name: {{$prefix}}{{.name}}-celery-worker
    spec:
      containers:
      - name: {{$prefix}}{{.name}}-celery-worker
        env:
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              key: aws-access-key-id
              name: {{$prefix}}{{.name}}
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key: aws-secret-access-key
              name: {{$prefix}}{{.name}}
        - name: AWS_DEFAULT_REGION
          valueFrom:
            configMapKeyRef:
              key: aws-default-region
              name: {{$prefix}}{{.name}}
        - name: AWS_SQS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              key: aws-sqs-access-key-id
              name: {{$prefix}}{{.name}}
        - name: AWS_SQS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key: aws-sqs-secret-access-key
              name: {{$prefix}}{{.name}}
        - name: AWS_SQS_REGION
          valueFrom:
            configMapKeyRef:
              key: aws-sqs-region
              name: {{$prefix}}{{.name}}
        - name: AWS_NAME_PREFIX
          valueFrom:
            configMapKeyRef:
              key: aws-name-prefix
              name: {{$prefix}}{{.name}}
        - name: DJANGO_SETTINGS_MODULE
          valueFrom:
            configMapKeyRef:
              key: django-settings-module
              name: {{$prefix}}{{.name}}
        - name: DJANGO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: django-secret-key
              name: {{$prefix}}{{.name}}
        - name: DJANGO_ALLOWED_HOSTS
          valueFrom:
            configMapKeyRef:
              key: django-allowed-hosts
              name: {{$prefix}}{{.name}}
{{if or (eq .env "local") (eq .env "review")}}
        - name: DJANGO_DATABASE_NAME
          valueFrom:
            secretKeyRef:
              key: database-name
              name: {{env "DB_SECRETS_FILE_NAME" | default .db.secretsFileName}}
        - name: DJANGO_DATABASE_HOST
          valueFrom:
            configMapKeyRef:
              key: django-database-host
              name: {{$prefix}}{{.name}}
        - name: DJANGO_DATABASE_USER
          valueFrom:
            secretKeyRef:
              key: database-user
              name: {{env "DB_SECRETS_FILE_NAME" | default .db.secretsFileName}}
        - name: DJANGO_DATABASE_PASSWORD
          valueFrom:
            secretKeyRef:
              key: database-password
              name: {{env "DB_SECRETS_FILE_NAME" | default .db.secretsFileName}}
{{else}}
        - name: DJANGO_DATABASE_NAME
          valueFrom:
            configMapKeyRef:
              key: database-name
              name: {{$prefix}}{{.name}}
        - name: DJANGO_DATABASE_PORT
          valueFrom:
            configMapKeyRef:
              key: database-port
              name: {{$prefix}}{{.name}}
        - name: DJANGO_DATABASE_HOST
          valueFrom:
            configMapKeyRef:
              key: django-database-host
              name: {{$prefix}}{{.name}}
        - name: DJANGO_DATABASE_USER
          valueFrom:
            secretKeyRef:
              key: database-user
              name: {{$prefix}}{{.name}}
        - name: DJANGO_DATABASE_PASSWORD
          valueFrom:
            secretKeyRef:
              key: database-password
              name: {{$prefix}}{{.name}}
{{end}}
        - name: DJANGO_DEBUG
          valueFrom:
            configMapKeyRef:
              key: django-debug
              name: {{$prefix}}{{.name}}
        - name: HOUNDIGRADE_ECS_CLUSTER_NAME
          valueFrom:
            configMapKeyRef:
              key: aws-houndigrade-ecs-cluster-name
              name: {{$prefix}}{{.name}}
        - name: HOUNDIGRADE_ECS_IMAGE_NAME
          valueFrom:
            configMapKeyRef:
              key: aws-houndigrade-ecs-image-name
              name: {{$prefix}}{{.name}}
        - name: HOUNDIGRADE_ECS_IMAGE_TAG
          valueFrom:
            configMapKeyRef:
              key: aws-houndigrade-ecs-image-tag
              name: {{$prefix}}{{.name}}
        - name: HOUNDIGRADE_ECS_FAMILY_NAME
          valueFrom:
            configMapKeyRef:
              key: aws-houndigrade-ecs-family-name
              name: {{$prefix}}{{.name}}
        - name: HOUNDIGRADE_AWS_AVAILABILITY_ZONE
          valueFrom:
            configMapKeyRef:
              key: aws-houndigrade-availability-zone
              name: {{$prefix}}{{.name}}
        - name: HOUNDIGRADE_AWS_AUTOSCALING_GROUP_NAME
          valueFrom:
            configMapKeyRef:
              key: aws-houndigrade-autoscaling-group-name
              name: {{$prefix}}{{.name}}
        - name: SCALE_UP_INSPECTION_CLUSTER_SCHEDULE
          valueFrom:
            configMapKeyRef:
              key: aws-houndigrade-scale-up-cluster-schedule
              name: {{$prefix}}{{.name}}
        - name: PERSIST_INSPECTION_CLUSTER_RESULTS_SCHEDULE
          valueFrom:
            configMapKeyRef:
              key: aws-houndigrade-persist-inspection-results-schedule
              name: {{$prefix}}{{.name}}
        - name: CLOUDTRAIL_EVENT_URL
          valueFrom:
            configMapKeyRef:
              key: aws-cloudtrail-event-url
              name: {{$prefix}}{{.name}}
        - name: S3_BUCKET_NAME
          valueFrom:
            configMapKeyRef:
              key: aws-s3-bucket-name
              name: {{$prefix}}{{.name}}
{{if or (env "CELERY_SENTRY_ENABLED") (.celery.sentry.enabled)}}
        - name: CELERY_ENABLE_SENTRY
          valueFrom:
            configMapKeyRef:
              key: celery-sentry-enabled
              name: {{$prefix}}{{.name}}
        - name: CELERY_SENTRY_DSN
          valueFrom:
            secretKeyRef:
              key: celery-sentry-dsn
              name: {{$prefix}}{{.name}}
        - name: CELERY_SENTRY_RELEASE
          valueFrom:
            configMapKeyRef:
              key: celery-sentry-release
              name: {{$prefix}}{{.name}}
        - name: CELERY_SENTRY_ENVIRONMENT
          valueFrom:
            configMapKeyRef:
              key: celery-sentry-environment
              name: {{$prefix}}{{.name}}
{{end}}
{{if and (ne .env "local") (ne .env "review")}}
        image: {{env "CELERY_IMAGE"}}
{{else}}
        image: ' '
        imagePullPolicy: Always
{{end}}
        command:
          - /bin/sh
          - -c
          - >
            PYTHONPATH=. scl enable rh-python36 --
            celery worker
            --app config
            --loglevel info
            --concurrency 1
            --queues initial_aws_describe_instances,copy_ami_snapshot,copy_ami_to_customer_account,remove_snapshot_ownership,create_volume,delete_snapshot,enqueue_ready_volumes,scale_up_inspection_cluster,run_inspection_cluster,persist_inspection_cluster_results_task,scale_down_cluster,analyze_log
{{if ne .env "local"}}
        resources:
          requests:
            cpu: {{.celery.worker.limits.container.cpuRequest}}
            memory: {{.celery.worker.limits.container.memRequest}}
          limits:
            cpu: {{.celery.worker.limits.container.cpuLimit}}
            memory: {{.celery.worker.limits.container.memLimit}}
{{end}}
        livenessProbe:
          exec:
            command:
              - /bin/sh
              - -c
              - 'ps axo command | grep -v grep | grep python'
          failureThreshold: 3
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        readinessProbe:
          exec:
            command:
              - /bin/sh
              - -c
              - '[[ $(ps axo command | grep "[p]ython" | grep celery | grep -c worker) -gt 1 ]]'
          failureThreshold: 3
          initialDelaySeconds: 5
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
{{if or (eq .env "local") (eq .env "review")}}
  triggers:
    - type: "ImageChange"
      imageChangeParams:
        automatic: {{.celery.enableImageChangeTrigger}}
        containerNames:
          - {{$prefix}}{{.name}}-celery-worker
        from:
          kind: ImageStreamTag
          name: {{$prefix}}{{.celery.imageStreamName}}:{{.celery.imageStreamTag}}
    - type: ConfigChange
{{end}}
