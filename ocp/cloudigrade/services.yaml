{{$prefix := or (env "DEPLOYMENT_PREFIX") ""}}
---
kind: Service
apiVersion: v1
metadata:
  name: {{$prefix}}{{.name}}-api
  labels:
{{if (env "CI_ENVIRONMENT_SLUG")}}
    app: {{env "CI_ENVIRONMENT_SLUG"}}
{{end}}
    deployment: {{$prefix}}{{.name}}-deployment
{{if (env "GITLAB_DEPLOYMENT")}}
    gitlab-deployment: {{env "GITLAB_DEPLOYMENT"}}
{{end}}
spec:
  selector:
    name: {{$prefix}}{{.name}}-api
  ports:
  - name: {{$prefix}}nginx
    port: 80
    protocol: TCP
    targetPort: {{.nginx.port}}
  sessionAffinity: None
  type: ClusterIP
